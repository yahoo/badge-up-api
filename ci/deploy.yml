---
platform: linux

image: docker:///ubuntu#14.04

inputs:
  - name: ami-id

run:
  path: sh
  args:
  - -exc
  - |
    apt-get update
    apt-get install -y wget unzip
    whoami
    env
    ls
    find .
    pwd
    TERRAFORM_DIR=/usr/local/bin
    TERRAFORM_VER=0.6.14
    mkdir -p $TERRAFORM_DIR
    cd $TERRAFORM_DIR
    wget https://releases.hashicorp.com/terraform/${TERRAFORM_VER}/terraform_${TERRAFORM_VER}_linux_amd64.zip
    unzip terraform_${TERRAFORM_VER}_linux_amd64.zip
    cd -
    env
    AMI_ID=$(cat ami-id/ami-id)
    cd stinking-badges/infrastructure/dev
    /usr/local/bin/terraform plan -out=terraform_plan -var "ami_id=${AMI_ID}"
    /usr/local/bin/terraform apply terraform_plan
